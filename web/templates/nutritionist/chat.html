{% extends "shared/base.html" %}

{% block title %}Consulta Nutricional - ShapeMateAI{% endblock %}

{% block content %}
<div class="d-flex flex-column" style="height: 100vh;">
    <div class="card border-0 h-100" style="border-radius: 0;">
        <div class="card-header bg-gradient-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        <i class="fas fa-stethoscope me-2"></i>
                        Consulta com Nutrion
                    </h5>
                    <small>Nutricionista virtual personalizado ‚Ä¢ {{ user.name or 'Paciente' }}</small>
                </div>
                <div>
                    <button class="btn btn-light btn-sm" onclick="resetConsultation()" style="background-color: white; color: #28a745; border-color: white;">
                        <i class="fas fa-refresh me-2"></i>Recome√ßar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Progress Indicator -->
        <div class="progress-container bg-light" style="height: 8px;">
            <div id="consultationProgress" class="progress-bar bg-success" style="width: 0%; transition: width 0.3s ease;"></div>
        </div>
        
        <!-- Phase Indicator -->
        <div class="bg-light px-3 py-2 border-bottom">
            <small class="text-muted">
                <i class="fas fa-compass me-2"></i>
                <span id="currentPhase">Carregando...</span>
            </small>
        </div>
        
        <div class="card-body d-flex flex-column p-0 flex-grow-1">
            <!-- Chat Messages Area -->
            <div class="flex-grow-1 p-3" id="chatMessages" style="overflow-y: auto; background-color: #f8f9fa;">
                <!-- Loading message -->
                <div id="loadingMessage" class="text-center py-5">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3 text-muted">Preparando sua consulta personalizada...</p>
                </div>
                
                <!-- Dynamic messages will be added here -->
            </div>

            <!-- Action Buttons (shown during decision phase) -->
            <div id="actionButtons" class="p-3 bg-white border-top d-none">
                <div class="row g-2">
                    <div class="col-md-6">
                        <button class="btn btn-success w-100" onclick="executeAction('generate_diet')">
                            <i class="fas fa-clipboard-list me-2"></i>
                            üéØ Gerar Dieta Personalizada
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-success w-100" onclick="executeAction('add_information')">
                            <i class="fas fa-plus me-2"></i>
                            üìù Adicionar Mais Informa√ß√µes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Message Input Area -->
            <div id="messageInputArea" class="p-3 bg-white border-top">
                <div class="input-group">
                    <input type="text" 
                           class="form-control" 
                           id="messageInput" 
                           placeholder="Digite sua resposta..." 
                           disabled>
                    <button class="btn btn-success" 
                            type="button" 
                            id="sendButton" 
                            onclick="sendMessage()"
                            disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- Quick suggestions (shown for specific questions) -->
                <div id="quickSuggestions" class="mt-2 d-none">
                    <small class="text-muted mb-2 d-block">Sugest√µes r√°pidas:</small>
                    <div class="d-flex flex-wrap gap-2" id="suggestionsList">
                        <!-- Suggestions will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="px-3 py-2 d-none">
                <div class="d-flex align-items-center">
                    <div class="avatar text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px; background-color: #28a745;">
                        <i class="fas fa-stethoscope"></i>
                    </div>
                    <div class="typing-animation">
                        <span></span>
                        <span></span>
                        <span></span>
                        <span style="margin-right: 0;"></span>
                    </div>
                    <small class="text-muted ms-2">Nutrion est√° respondendo...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Consultation Success Modal -->
<div class="modal fade" id="consultationSuccessModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>
                    Consulta Finalizada!
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-clipboard-check text-success" style="font-size: 3rem;"></i>
                </div>
                <h6>Sua dieta personalizada foi criada com sucesso!</h6>
                <p class="text-muted">Baseada em todas as suas prefer√™ncias e objetivos.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="goToDashboard()">
                    <i class="fas fa-home me-2"></i>
                    Ir para Dashboard
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.chat-message {
    margin-bottom: 1rem;
}

.user-message .message-content {
    margin-left: auto;
    max-width: 70%;
}

.user-message .message-content .bg-primary {
    background-color: #28a745 !important;
}

.assistant-message .message-content {
    max-width: 80%;
}

.typing-animation {
    display: flex;
    align-items: center;
}

.typing-animation span {
    height: 8px;
    width: 8px;
    background-color: #28a745;
    border-radius: 50%;
    display: inline-block;
    margin-right: 3px;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-animation span:nth-child(1) { animation-delay: -0.32s; }
.typing-animation span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

#chatMessages {
    scroll-behavior: smooth;
    height: calc(100vh - 300px);
}

.suggestion-chip {
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 20px;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.suggestion-chip:hover {
    background-color: #28a745;
    color: white;
    border-color: #28a745;
}

.progress-container {
    position: relative;
    overflow: hidden;
}

.phase-indicator {
    font-size: 0.9rem;
    font-weight: 500;
}

/* Override any blue colors */
.btn-primary {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
}

.btn-primary:hover {
    background-color: #1e7e34 !important;
    border-color: #1c7430 !important;
}

.bg-primary {
    background-color: #28a745 !important;
}

.bg-gradient-primary {
    background: linear-gradient(45deg, #28a745, #20c997) !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let consultationState = null;
let isWaitingForResponse = false;

// Phase mapping for progress indicator
const phaseProgress = {
    'greeting_and_introduction': 10,
    'goals_clarification': 20,
    'preferences_collection': 60,
    'lifestyle_assessment': 80,
    'social_economic_context': 90,
    'summary_and_decision': 100
};

const phaseNames = {
    'greeting_and_introduction': 'Apresenta√ß√£o e boas-vindas',
    'goals_clarification': 'Definindo seus objetivos',
    'preferences_collection': 'Descobrindo seus gostos',
    'lifestyle_assessment': 'Entendendo seu estilo de vida',
    'social_economic_context': 'Contexto social e econ√¥mico',
    'summary_and_decision': 'Resumo e decis√£o',
    'additional_information_gathering': 'Informa√ß√µes adicionais'
};

// Initialize consultation when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeConsultation();
});

// Handle Enter key in message input
document.getElementById('messageInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey && !this.disabled) {
        e.preventDefault();
        sendMessage();
    }
});

async function initializeConsultation() {
    try {
        showTypingIndicator();
        
        const response = await fetch('/api/nutritionist/consultation/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        hideTypingIndicator();
        document.getElementById('loadingMessage').style.display = 'none';
        
        if (result.success) {
            consultationState = result.consultation_state;
            updateUI(result);
            addMessage('assistant', result.current_message);
            enableInput();
        } else {
            showError(result.message || 'Erro ao iniciar consulta');
        }
        
    } catch (error) {
        hideTypingIndicator();
        showError('Erro de conex√£o ao iniciar consulta');
        console.error('Error initializing consultation:', error);
    }
}

async function sendMessage() {
    if (isWaitingForResponse) return;
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage('user', message);
    
    // Clear input and disable
    messageInput.value = '';
    disableInput();
    isWaitingForResponse = true;
    
    // Hide suggestions and action buttons
    hideQuickSuggestions();
    hideActionButtons();
    
    // Show typing indicator
    showTypingIndicator();
    
    try {
        const response = await fetch('/api/nutritionist/consultation/respond', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ response: message })
        });
        
        const result = await response.json();
        
        hideTypingIndicator();
        isWaitingForResponse = false;
        
        if (result.success) {
            consultationState = result.consultation_state;
            updateUI(result);
            addMessage('assistant', result.current_message);
            
            // Show action buttons if decision point
            if (result.show_action_buttons) {
                showActionButtons();
            } else {
                enableInput();
            }
        } else {
            showError(result.message || 'Erro ao processar resposta');
            enableInput();
        }
        
    } catch (error) {
        hideTypingIndicator();
        isWaitingForResponse = false;
        enableInput();
        showError('Erro de conex√£o ao enviar mensagem');
        console.error('Error sending message:', error);
    }
}

async function executeAction(action) {
    try {
        hideActionButtons();
        
        if (action === 'generate_pdf') {
            // Mostrar indicador especial para gera√ß√£o do PDF final
            addMessage('assistant', 'üìÑ **GERANDO PDF DA SUA DIETA PERSONALIZADA**\n\n' +
                '‚úÖ Dados nutricionais verificados\n' +
                'üìä Card√°pio semanal organizado\n' +
                'üé® Formatando documento profissional\n' +
                'üíæ Salvando no seu perfil\n\n' +
                '‚è≥ Aguarde, estou finalizando sua dieta...');
        } else if (action === 'modify_diet') {
            addMessage('assistant', 'üîÑ **MODO DE MODIFICA√á√ÉO ATIVADO**\n\n' +
                'Me diga o que voc√™ gostaria de alterar na sua dieta:\n' +
                '‚Ä¢ Trocar algum alimento espec√≠fico\n' +
                '‚Ä¢ Ajustar quantidades\n' +
                '‚Ä¢ Modificar hor√°rios das refei√ß√µes\n' +
                '‚Ä¢ Alterar distribui√ß√£o de macronutrientes\n\n' +
                'O que voc√™ gostaria de modificar?');
            
            // Reativar input para modifica√ß√µes
            enableInput();
            return;
        } else if (action === 'generate_diet') {
            // A√ß√£o antiga - manter compatibilidade
            addMessage('assistant', 'üßÆ **INICIANDO GERA√á√ÉO DA DIETA PERSONALIZADA**\n\n' +
                'üìä Calculando sua Taxa Metab√≥lica Basal (TMB)...\n' +
                '‚ö° Aplicando fator de atividade f√≠sica...\n' +
                'üéØ Ajustando calorias para seu objetivo...\n' +
                'ü•ó Distribuindo macronutrientes...\n' +
                'üìã Criando card√°pio com seus alimentos preferidos...\n\n' +
                '‚è≥ Aguarde, estou analisando todas as suas informa√ß√µes...');
        }
        
        showTypingIndicator();
        
        const response = await fetch('/api/nutritionist/consultation/action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action: action })
        });
        
        const result = await response.json();
        
        hideTypingIndicator();
        
        if (result.success) {
            if (result.action === 'diet_generated' || result.action === 'pdf_generated') {
                addMessage('assistant', result.message);
                
                // Redirecionar para dashboard ap√≥s 3 segundos
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 3000);
            } else if (result.action === 'continue_consultation') {
                consultationState = result.consultation_state;
                addMessage('assistant', result.message);
                enableInput();
                // Reexibir input de mensagem se voltou para consulta
                document.getElementById('messageInput').style.display = 'block';
                document.getElementById('sendButton').style.display = 'block';
            } else if (result.action === 'modification_mode') {
                // Modo de modifica√ß√£o ativado
                consultationState = result.consultation_state;
                enableInput();
            }
        } else {
            showError(result.message || 'Erro ao executar a√ß√£o');
            showActionButtons(); // Show buttons again
        }
        
    } catch (error) {
        hideTypingIndicator();
        showActionButtons();
        showError('Erro de conex√£o ao executar a√ß√£o');
        console.error('Error executing action:', error);
    }
}

async function resetConsultation() {
    if (confirm('Tem certeza que deseja recome√ßar a consulta? Todas as informa√ß√µes ser√£o perdidas.')) {
        try {
            await fetch('/api/nutritionist/consultation/reset', { method: 'POST' });
            location.reload();
        } catch (error) {
            console.error('Error resetting consultation:', error);
            location.reload();
        }
    }
}

function updateUI(result) {
    // Update progress bar
    const progress = phaseProgress[result.current_phase] || 0;
    document.getElementById('consultationProgress').style.width = progress + '%';
    
    // Update phase indicator
    const phaseName = phaseNames[result.current_phase] || 'Processando...';
    document.getElementById('currentPhase').textContent = phaseName;
}

function addMessage(type, content) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}-message mb-3`;
    
    const now = new Date().toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    if (type === 'user') {
        messageDiv.innerHTML = `
            <div class="d-flex justify-content-end">
                <div class="message-content">
                    <div class="bg-primary text-white rounded p-3 shadow-sm">
                        ${content.replace(/\n/g, '<br>')}
                    </div>
                    <small class="text-muted d-block text-end mt-1">${now}</small>
                </div>
                <div class="avatar text-white rounded-circle d-flex align-items-center justify-content-center ms-3" style="width: 40px; height: 40px; background-color: #007bff;">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="d-flex">
                <div class="avatar text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background-color: #28a745;">
                    <i class="fas fa-stethoscope"></i>
                </div>
                <div class="message-content">
                    <div class="bg-white rounded p-3 shadow-sm">
                        ${content.replace(/\n/g, '<br>')}
                    </div>
                    <small class="text-muted d-block mt-1">${now}</small>
                </div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    
    // NOVA FUNCIONALIDADE: Detectar "A√á√ÉO_DIETA_PRONTA" e mostrar bot√µes
    if (type === 'assistant' && content.includes('A√á√ÉO_DIETA_PRONTA')) {
        // Remover o c√≥digo interno da mensagem exibida
        const cleanContent = content.replace('A√á√ÉO_DIETA_PRONTA', '').trim();
        
        // Atualizar o conte√∫do da mensagem para remover o c√≥digo
        const messageContentDiv = messageDiv.querySelector('.bg-white');
        if (messageContentDiv) {
            messageContentDiv.innerHTML = cleanContent.replace(/\n/g, '<br>');
        }
        
        // Esconder o input de mensagem
        document.getElementById('messageInput').style.display = 'none';
        document.getElementById('sendButton').style.display = 'none';
        
        // Mostrar os bot√µes de a√ß√£o espec√≠ficos para dieta
        showDietActionButtons();
        
        // Atualizar progresso para 100%
        document.getElementById('consultationProgress').style.width = '100%';
        document.getElementById('currentPhase').textContent = 'Dieta Pronta - Escolha sua pr√≥xima a√ß√£o';
    }
    
    // Manter compatibilidade com c√≥digo antigo
    else if (type === 'assistant' && content.includes('ESCOLHA_OPCOES_FINAIS')) {
        // Remover o c√≥digo interno da mensagem exibida
        const cleanContent = content.replace('ESCOLHA_OPCOES_FINAIS', '').trim();
        
        // Atualizar o conte√∫do da mensagem para remover o c√≥digo
        const messageContentDiv = messageDiv.querySelector('.bg-white');
        if (messageContentDiv) {
            messageContentDiv.innerHTML = cleanContent.replace(/\n/g, '<br>');
        }
        
        // Esconder o input de mensagem
        document.getElementById('messageInput').style.display = 'none';
        document.getElementById('sendButton').style.display = 'none';
        
        // Mostrar os bot√µes de a√ß√£o
        document.getElementById('actionButtons').classList.remove('d-none');
        
        // Atualizar progresso para 100%
        document.getElementById('consultationProgress').style.width = '100%';
        document.getElementById('currentPhase').textContent = 'Consulta Finalizada - Escolha sua pr√≥xima a√ß√£o';
    }
}

function showTypingIndicator() {
    document.getElementById('typingIndicator').classList.remove('d-none');
    scrollToBottom();
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').classList.add('d-none');
}

function enableInput() {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    
    messageInput.disabled = false;
    sendButton.disabled = false;
    messageInput.focus();
}

function disableInput() {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    
    messageInput.disabled = true;
    sendButton.disabled = true;
}

function showActionButtons() {
    document.getElementById('actionButtons').classList.remove('d-none');
    document.getElementById('messageInputArea').classList.add('d-none');
    scrollToBottom();
}

function hideActionButtons() {
    document.getElementById('actionButtons').classList.add('d-none');
    document.getElementById('messageInputArea').classList.remove('d-none');
}

function showDietActionButtons() {
    // Atualizar os bot√µes para a√ß√µes espec√≠ficas da dieta
    const actionButtons = document.getElementById('actionButtons');
    
    // Limpar bot√µes existentes e adicionar novos
    actionButtons.innerHTML = `
        <div class="row g-2">
            <div class="col-md-6">
                <button class="btn btn-success w-100" onclick="executeAction('generate_pdf')">
                    <i class="fas fa-file-pdf me-2"></i>
                    Gerar PDF da Dieta
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-outline-success w-100" onclick="executeAction('modify_diet')">
                    <i class="fas fa-edit me-2"></i>
                    Modificar Dieta
                </button>
            </div>
        </div>
    `;
    
    actionButtons.classList.remove('d-none');
    document.getElementById('messageInputArea').classList.add('d-none');
    scrollToBottom();
}

function showQuickSuggestions(suggestions) {
    const suggestionsContainer = document.getElementById('quickSuggestions');
    const suggestionsList = document.getElementById('suggestionsList');
    
    suggestionsList.innerHTML = '';
    
    suggestions.forEach(suggestion => {
        const chip = document.createElement('span');
        chip.className = 'suggestion-chip';
        chip.textContent = suggestion;
        chip.onclick = () => {
            document.getElementById('messageInput').value = suggestion;
            hideQuickSuggestions();
        };
        suggestionsList.appendChild(chip);
    });
    
    suggestionsContainer.classList.remove('d-none');
}

function hideQuickSuggestions() {
    document.getElementById('quickSuggestions').classList.add('d-none');
}

function showSuccessModal() {
    const modal = new bootstrap.Modal(document.getElementById('consultationSuccessModal'));
    modal.show();
}

function goToDashboard() {
    window.location.href = '/dashboard';
}

function showError(message) {
    addMessage('assistant', `‚ùå ${message}`);
}

function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
}
</script>
{% endblock %}
